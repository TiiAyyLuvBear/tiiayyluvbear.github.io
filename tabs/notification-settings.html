<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C·∫•u h√¨nh Th√¥ng b√°o - IoT Dashboard</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .settings-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .settings-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        
        .settings-section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #4CAF50;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-primary {
            background-color: #4CAF50;
            color: white;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn:hover {
            opacity: 0.8;
        }
        
        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .range-input {
            width: 100%;
        }
        
        .range-value {
            font-weight: bold;
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <div class="settings-container">
        <h1>‚öôÔ∏è C·∫•u h√¨nh Th√¥ng b√°o Push</h1>
        
        <div id="statusMessage" class="status-message"></div>
        
        <!-- Pushsafer API Configuration -->
        <div class="settings-section">
            <h3>üîë C·∫•u h√¨nh Pushsafer API</h3>
            <div class="form-group">
                <label for="pushsaferKey">Private Key:</label>
                <input type="password" id="pushsaferKey" placeholder="Nh·∫≠p Private Key t·ª´ Pushsafer">
                <small>L·∫•y Private Key t·ª´ <a href="https://www.pushsafer.com" target="_blank">pushsafer.com</a></small>
            </div>
            <button class="btn btn-primary" onclick="savePushsaferKey()">üíæ L∆∞u Key</button>
            <button class="btn btn-secondary" onclick="testNotification()">üîî Test Notification</button>
        </div>
        
        <!-- Notification Toggle -->
        <div class="settings-section">
            <h3>üîî B·∫≠t/T·∫Øt Th√¥ng b√°o</h3>
            <div class="form-group">
                <label>
                    Th√¥ng b√°o nhi·ªát ƒë·ªô:
                    <label class="toggle-switch">
                        <input type="checkbox" id="tempNotification">
                        <span class="slider"></span>
                    </label>
                </label>
            </div>
            <div class="form-group">
                <label>
                    Th√¥ng b√°o √°nh s√°ng:
                    <label class="toggle-switch">
                        <input type="checkbox" id="lightNotification">
                        <span class="slider"></span>
                    </label>
                </label>
            </div>
            <div class="form-group">
                <label>
                    Th√¥ng b√°o chuy·ªÉn ƒë·ªông:
                    <label class="toggle-switch">
                        <input type="checkbox" id="motionNotification">
                        <span class="slider"></span>
                    </label>
                </label>
            </div>
        </div>
        
        <!-- Threshold Settings -->
        <div class="settings-section">
            <h3>‚ö†Ô∏è Ng∆∞·ª°ng C·∫£nh b√°o</h3>
            <div class="form-group">
                <label for="tempHigh">Nhi·ªát ƒë·ªô cao (¬∞C): <span class="range-value" id="tempHighValue">35</span></label>
                <input type="range" id="tempHigh" class="range-input" min="25" max="50" value="35">
            </div>
            <div class="form-group">
                <label for="tempLow">Nhi·ªát ƒë·ªô th·∫•p (¬∞C): <span class="range-value" id="tempLowValue">10</span></label>
                <input type="range" id="tempLow" class="range-input" min="0" max="20" value="10">
            </div>
            <div class="form-group">
                <label for="lightLow">√Ånh s√°ng th·∫•p (%): <span class="range-value" id="lightLowValue">20</span></label>
                <input type="range" id="lightLow" class="range-input" min="0" max="50" value="20">
            </div>
            <button class="btn btn-primary" onclick="saveThresholds()">üíæ L∆∞u Ng∆∞·ª°ng</button>
        </div>
        
        <!-- Sound Settings -->
        <div class="settings-section">
            <h3>üîä C√†i ƒë·∫∑t √Çm thanh</h3>
            <div class="form-group">
                <label for="tempSound">√Çm thanh nhi·ªát ƒë·ªô:</label>
                <select id="tempSound">
                    <option value="1">Default</option>
                    <option value="8">Notification</option>
                    <option value="11" selected>Alarm</option>
                    <option value="15">Alert</option>
                    <option value="22">Emergency</option>
                </select>
            </div>
            <div class="form-group">
                <label for="lightSound">√Çm thanh √°nh s√°ng:</label>
                <select id="lightSound">
                    <option value="1">Default</option>
                    <option value="8" selected>Notification</option>
                    <option value="11">Alarm</option>
                    <option value="15">Alert</option>
                </select>
            </div>
            <div class="form-group">
                <label for="motionSound">√Çm thanh chuy·ªÉn ƒë·ªông:</label>
                <select id="motionSound">
                    <option value="1">Default</option>
                    <option value="8">Notification</option>
                    <option value="11">Alarm</option>
                    <option value="15" selected>Alert</option>
                    <option value="22">Emergency</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="saveSoundSettings()">üíæ L∆∞u √Çm thanh</button>
        </div>
        
        <!-- Import/Export Settings -->
        <div class="settings-section">
            <h3>üìÅ Sao l∆∞u & Kh√¥i ph·ª•c</h3>
            <button class="btn btn-secondary" onclick="exportSettings()">üì§ Xu·∫•t c·∫•u h√¨nh</button>
            <button class="btn btn-secondary" onclick="importSettings()">üì• Nh·∫≠p c·∫•u h√¨nh</button>
            <button class="btn btn-danger" onclick="resetSettings()">üîÑ ƒê·∫∑t l·∫°i m·∫∑c ƒë·ªãnh</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImportFile(event)">
        </div>
        
        <div class="form-group">
            <button class="btn btn-secondary" onclick="goBack()">‚¨ÖÔ∏è Quay l·∫°i Dashboard</button>
        </div>
    </div>

    <script type="module">
        import { NotificationConfig } from '../js/notification-config.js';
        import { PushsaferNotifier } from '../js/pushsafer.js';
        
        let notificationConfig;
        let pushNotifier;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            notificationConfig = new NotificationConfig();
            pushNotifier = new PushsaferNotifier();
            loadSettings();
            setupEventListeners();
        });
        
        function loadSettings() {
            // Load Pushsafer key
            document.getElementById('pushsaferKey').value = notificationConfig.getPushsaferKey();
            
            // Load notification toggles
            document.getElementById('tempNotification').checked = notificationConfig.isNotificationEnabled('temperature');
            document.getElementById('lightNotification').checked = notificationConfig.isNotificationEnabled('light');
            document.getElementById('motionNotification').checked = notificationConfig.isNotificationEnabled('motion');
            
            // Load thresholds
            const thresholds = notificationConfig.getThresholds();
            document.getElementById('tempHigh').value = thresholds.temperature.high;
            document.getElementById('tempHighValue').textContent = thresholds.temperature.high;
            document.getElementById('tempLow').value = thresholds.temperature.low;
            document.getElementById('tempLowValue').textContent = thresholds.temperature.low;
            document.getElementById('lightLow').value = thresholds.light.low;
            document.getElementById('lightLowValue').textContent = thresholds.light.low;
            
            // Load sound settings
            document.getElementById('tempSound').value = notificationConfig.getSound('temperature');
            document.getElementById('lightSound').value = notificationConfig.getSound('light');
            document.getElementById('motionSound').value = notificationConfig.getSound('motion');
        }
        
        function setupEventListeners() {
            // Range inputs
            document.getElementById('tempHigh').addEventListener('input', function() {
                document.getElementById('tempHighValue').textContent = this.value;
            });
            
            document.getElementById('tempLow').addEventListener('input', function() {
                document.getElementById('tempLowValue').textContent = this.value;
            });
            
            document.getElementById('lightLow').addEventListener('input', function() {
                document.getElementById('lightLowValue').textContent = this.value;
            });
            
            // Notification toggles
            document.getElementById('tempNotification').addEventListener('change', function() {
                notificationConfig.toggleNotification('temperature', this.checked);
                showMessage('ƒê√£ c·∫≠p nh·∫≠t c√†i ƒë·∫∑t th√¥ng b√°o nhi·ªát ƒë·ªô', 'success');
            });
            
            document.getElementById('lightNotification').addEventListener('change', function() {
                notificationConfig.toggleNotification('light', this.checked);
                showMessage('ƒê√£ c·∫≠p nh·∫≠t c√†i ƒë·∫∑t th√¥ng b√°o √°nh s√°ng', 'success');
            });
            
            document.getElementById('motionNotification').addEventListener('change', function() {
                notificationConfig.toggleNotification('motion', this.checked);
                showMessage('ƒê√£ c·∫≠p nh·∫≠t c√†i ƒë·∫∑t th√¥ng b√°o chuy·ªÉn ƒë·ªông', 'success');
            });
        }
        
        window.savePushsaferKey = function() {
            const key = document.getElementById('pushsaferKey').value.trim();
            if (!key) {
                showMessage('Vui l√≤ng nh·∫≠p Private Key', 'error');
                return;
            }
            
            notificationConfig.setPushsaferKey(key);
            pushNotifier.setPushsaferKey(key);
            showMessage('ƒê√£ l∆∞u Pushsafer Private Key', 'success');
        };
        
        window.testNotification = async function() {
            const key = document.getElementById('pushsaferKey').value.trim();
            if (!key) {
                showMessage('Vui l√≤ng nh·∫≠p Private Key tr∆∞·ªõc khi test', 'error');
                return;
            }
            
            showMessage('ƒêang g·ª≠i test notification...', 'success');
            const success = await pushNotifier.testNotification();
            
            if (success) {
                showMessage('‚úÖ Test notification ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!', 'success');
            } else {
                showMessage('‚ùå G·ª≠i test notification th·∫•t b·∫°i. Ki·ªÉm tra l·∫°i Private Key.', 'error');
            }
        };
        
        window.saveThresholds = function() {
            const thresholds = {
                temperature: {
                    high: parseInt(document.getElementById('tempHigh').value),
                    low: parseInt(document.getElementById('tempLow').value)
                },
                light: {
                    low: parseInt(document.getElementById('lightLow').value)
                }
            };
            
            notificationConfig.updateThresholds(thresholds);
            pushNotifier.updateThresholds(thresholds);
            showMessage('ƒê√£ l∆∞u ng∆∞·ª°ng c·∫£nh b√°o', 'success');
        };
        
        window.saveSoundSettings = function() {
            const sounds = {
                temperature: parseInt(document.getElementById('tempSound').value),
                light: parseInt(document.getElementById('lightSound').value),
                motion: parseInt(document.getElementById('motionSound').value)
            };
            
            notificationConfig.set('sounds', sounds);
            showMessage('ƒê√£ l∆∞u c√†i ƒë·∫∑t √¢m thanh', 'success');
        };
        
        window.exportSettings = function() {
            const config = notificationConfig.exportConfig();
            const blob = new Blob([config], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'iot-notification-config.json';
            a.click();
            URL.revokeObjectURL(url);
            showMessage('ƒê√£ xu·∫•t c·∫•u h√¨nh', 'success');
        };
        
        window.importSettings = function() {
            document.getElementById('importFile').click();
        };
        
        window.handleImportFile = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const success = notificationConfig.importConfig(e.target.result);
                    if (success) {
                        loadSettings();
                        showMessage('ƒê√£ nh·∫≠p c·∫•u h√¨nh th√†nh c√¥ng', 'success');
                    } else {
                        showMessage('L·ªói nh·∫≠p c·∫•u h√¨nh', 'error');
                    }
                } catch (error) {
                    showMessage('File c·∫•u h√¨nh kh√¥ng h·ª£p l·ªá', 'error');
                }
            };
            reader.readAsText(file);
        };
        
        window.resetSettings = function() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒë·∫∑t l·∫°i t·∫•t c·∫£ c√†i ƒë·∫∑t v·ªÅ m·∫∑c ƒë·ªãnh?')) {
                notificationConfig.resetToDefaults();
                loadSettings();
                showMessage('ƒê√£ ƒë·∫∑t l·∫°i c√†i ƒë·∫∑t m·∫∑c ƒë·ªãnh', 'success');
            }
        };
        
        window.goBack = function() {
            window.location.href = 'dashboard.html';
        };
        
        function showMessage(message, type) {
            const messageEl = document.getElementById('statusMessage');
            messageEl.textContent = message;
            messageEl.className = `status-message status-${type}`;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>
